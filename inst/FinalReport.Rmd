---
title: "Final Report"
output: word_document
header-includes:
  - \usepackage{dsfont}
date: "2025-03-11"
bibliography: references2.bib
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Glossary

AFT - accelerated failure time

CRAN - the Comprehensive R Archive Network

ELBO - evidence based lower bound

GEO - Gene Expression Omnibus

HMC - Hamiltonian Monte Carlo

h-likelihood - hierarchical likelihood

MCMC - Markov Chain Monte Carlo

MSE - mean squared error

VB - variational Bayes

VI - variational inference

# Structured Abstract

## Context & Motivation

The `survregVB` R package is developed to implement mean-field variational Bayes (VB) algorithms for right-censored log-logistic accelerated failure time (AFT) models with and without frailty as an alternative to Markov Chain Monte Carlo (MCMC) methods. `survregVB` uses variational inference (VI) to approximate the posterior distributions of model parameters through optimization.

## Research Question & Objectives

How can VB inference be implemented as an R package for parametric survival regression of right-censored log-logistic AFT models with and without frailty? The objectives are to develop **survregVB**, and validate its performance through simulations and application to real-world data.

## Principal Ideas

This research integrates concepts related to Bayesian survival analysis, including VI, AFT models, and shared frailty along with R package development aspects including design, validation, and usability.

## Research Methodology

The research aims to build a prototype system, `survregVB`, implementing two mean-field VB algorithms for right-censored log-logistic AFT models with and without frailty. Performance is assessed through simulations and real-world applications. `survregVB` also includes a test suite, example data sets, documentation and a vignette.

## Anticipated Results

The primary outcome is the `survregVB` package, providing mean-field VB methods for log-logistic AFT models. Performance metrics will be obtained from simulation studies and data applications.

## Anticipated Novelty

While R packages exist for AFT model estimation, no integrated software supports VB methods for AFT models [@xian2024]. Compared to more traditional Bayesian approaches, the `survregVB` package offers similar estimation results with much lower computation time.

## Anticipated Impact of Results

Since no existing software provides VB methods for AFT models, the development of `survregVB` will fill this gap. Using `survregVB` to evaluate the VB algorithm will address its strengths and limitations and identify areas for future research.

# 1. Introduction

# 2. Background & Related Work

## 2.1 Survival Analysis

Survival analysis is the branch of statistics concerned with modelling time-to-event data, where the focus is on analyzing survival time, the length of time between an origin and an event of interest. The definition of an event (i.e. death, sickness, accident, bankruptcy, etc.) is highly variable, making survival analysis applicable across many domains, such as medicine, sociology, marketing or economics [@emmert-streib2019].

## 2.2 Censoring

In survival analysis, censored observations occur when the exact survival time is unknown for some individuals as the event of interest does not occur during the duration of a study or data collection. In specific, right censoring occurs when the time taken for event of interest to occur exceeds the observed length of time for an individual [@kobara2022statistical].

## 2.3 AFT Models

For situations where explanatory variables may affect survival time, usual survival distribution methods are insufficient. Since survival times are only positive (and therefore rarely normally distributed), and may contain censored observations, survival regression methods are necessary for analyzing survival data for non-homogeneous populations [@kobara2022statistical]. A commonly used survival regression model is the accelerated failure time (AFT) model, which assumes an accelerative effect of the covariates directly on survival time [@webber2022]. There are several possible distributions for the AFT model, including exponential, Weibull, log-logistic, log-normal or gamma. In particular, the log-logistic distribution is suitable for modelling a wide variety of survival data [@rivas-lópez2022].

For survival time $T_i$, censoring time $C_i$ and censoring indicator $\delta_i=\mathbb{1}(T_i\le C_i)$ for the $i^{th}$ subject in the sample, $i=1,...,n$, the log-logistic AFT model is represented as follows:

$$
log(T_i):=Y=\mathbf{X}_i^T\beta+bz_i
$$

where $\mathbf{X}_i$ is column vector of $p-1$ covariates and a constant one (i.e. $\mathbf{X}_i=(1,x_i1,...,x_i(p-1))^T$), $\beta$ is a vector of coefficients for the covariates, $z_i$ is a random variable following a standard logistic distribution and $b$ is a scale parameter [@xian2024].

### 2.3.1 With Shared Frailty

Frailty is a multiplicative, latent effect on the baseline hazard function used to account for heterogeneity and random effects. A shared frailty model is a random effects model where the frailties are shared among groups and randomly distributed across groups [@gutierrez2002]. In cases where correlated survival data arises from clusters of individuals with shared environmental factors, a shared frailty AFT model can be used to account for correlations among survival data [@hougaard1995; @hanagal2011; @gorfine2023]. Since the choice of distribution is not critical, the log-logistic AFT model can be used [@lambert2004].

For survival time $T_{ij}$, censoring time $C_{ij}$ and censoring indicator $\delta_{ij}=\mathbb{1}(T_{ij}\le C_{ij})$ for the $j^{th}$ subject from the $i^{th}$ cluster in a sample with $i=1,...,K$ clusters and $j=1,...,n_i$ subjects, the shared frailty log-logistic AFT model is represented as follows:

$$
\log(T_{ij})=\gamma_i+\mathbf{X}_{ij}^T\beta+b\epsilon_{ij}
$$

where $\mathbf{X}_{ij}$ is column vector of $p-1$ covariates and a constant one (i.e. $\mathbf{X}_{ij}=(1,x_{ij1},...,x_{ij(p-1)})^T$), $\beta$ is a vector of coefficients for the covariates, $\gamma_i$ is a random intercept for the $i^{th}$ cluster, $\epsilon_{ij}$ is a variable following a standard logistic distribution and $b$ is a scale parameter [@xian2024a].

## 2.4 Bayesian Inference

Bayesian inference is technique used to derive the posterior distribution of parameters based on Bayes’ theorem. For Bayesian models with many parameters, it is challenging to calculate the exact posterior distribution. Therefore, Markov Chain Monte Carlo (MCMC) algorithms are typically used to approximate the posterior [@geman1984]. In specific, Bayesian inference MCMC techniques are used for approximating posterior parameters for log-logistic AFT models via numerical approximation by sampling [@wainwright2007]. However, due to high computational costs, research has been done to explore alternative methods such as variational inference (VI) developed from machine learning [@jordan1999]. VI uses optimization to approximate the parameters of a Bayesian model, providing similar estimations to MCMC techniques at a much lower computational cost [@blei2017]. Furthermore, VI can make use of prior results from similar estimation studies to make predictions, and does not rely on asymptotic, making it useful for studies with small sample sizes [@ibrahim2001].

## 2.5 The Variational Bayes Algorithm

Mean-field variational Bayes (VB) is a special case of mean-field VI that arises from minimizing Kullback-Leibler (KL) divergence. KL divergence is used to measure the dissimilarity between the approximated and exact posterior densities [@bishop2006]. Minimizing KL divergence can also be thought of as maximizing the evidence lower-bound (ELBO) [@jordan1999; @blei2017]. An approximated posterior distribution can be obtained by using the coordinate ascent algorithm under VB to optimize the ELBO, also referred to as coordinate ascent variational inference (CAVI) [@bishop2006; @blei2017]. For Bayesian models with several parameters, it is difficult to obtain a closed form of the posterior distribution, so the exact posterior distribution is intractable. In these cases, a piecewise approximation technique is embedded into the VB algorithm to achieve Bayesian conjugacy [@xian2024].

## 2.6 Analysis & Research Gap

Several R packages currently exist to provide estimation methods for AFT models, including:

-   `survreg` from `survival` can be used to fit a likelihood-based parametric survival regression model with a log-logistic distribution [@survival].
-   `rstan` provides the MCMC-based Hamiltonian Monte Carlo (HMC) sampling algorithm for survival models [@rstan].
-   `survregBayes` from `spBayesSurv` uses MCMC-based Bayesian inference to estimate shared frailty AFT models [@spBayesSurv].
-   `frailtyHL` implements the hierarchical likelihood (h-likelihood) approach for shared frailty AFT models [@ha2012].

However, VB methods for AFT models are a relatively recent development, and currently no integrated software exists for their practical implementation [@xian2024]. Compared to more traditional Bayesian approaches, the`survregVB` package offers the following advantages:

-   Significantly reduced computation cost with similar estimation results compared to MCMC, with an average speedup of up to 300 times [@xian2024].

-   Can outperform likelihood-based methods in terms of empirical mean squared error (MSE) [@xian2024].

-   Its ability to make use of information from previous studies to make predictions [@ibrahim2001].

-   VI does not rely on asymptotic, making it useful for studies with small sample sizes [@ibrahim2001].

# 3. Research Objectives

The study aims to:

O1. Develop an R package, `survregVB`, that implements mean-field VB algorithms for parametric survival regression in log-logistic AFT models.

O2. Provide an accessible and user-friendly interface, ensuring ease of use for survival analysis.

O3. Extend VB inference to models with and without shared frailty to enable analysis of clustered survival data.

O4. Create a comprehensive test suite to ensure the correctness of the package.

O5. Develop thorough function documentation to improve usability and understanding for users.

O6. Create a vignette to provide examples and guidance for users through key functionalities.

O7. Validate the performance of `survregVB` using simulation studies to assess accuracy and efficiency.

O8. Evaluate `survregVB` on publicly available survival data sets to compare its results against traditional MCMC-based methods.

O9. Submit `survregVB` to the Comprehensive R Archive Network (CRAN) to improve accessibility and ensure that it meets R package development standards.

# 4. Methodology

## 4.1 Development Approaches

The research aims to build a prototype system, the `survregVB` R package, which implements two mean-field VB algorithms for right-censored log-logistic AFT models with and without shared frailty respectively. The performance of `survregVB` will be assessed through:

-   Simulation studies – Generating synthetic survival data sets to evaluate estimation accuracy and computational cost.

-   Analysis of publicly available data sets – Applying `survregVB` to real-world survival data and comparing results with traditional parametric methods.

To ensure usability, accuracy, and compliance with R package development standards, `survregVB` will include:

-   A test suite for verifying function correctness.
-   Function documentation to guide users.
-   S3 print and summary methods to display results of the fitted model.
-   A vignette to provide practical examples and usage instructions.
-   Submission to CRAN to improve accessibility and ensure adherence to R package standards.

## 4.2 Tools & Techniques

-   The `survival` Package provides the standard functions for survival modeling in R, ensuring that `survregVB` is compatible with existing workflows [@survival].

-   Stan allows MCMC-based validation of VB results, ensuring model accuracy [@rstan].

-   Package development tools like `devtools`, `usethis`, and `testthat`, are used to maintain code quality in `survregVB` [@silge2019].

## 4.3 Algorithms

`survregVB` implements two mean-field variational Bayes (VB) algorithms for right-censored log-logistic AFT models with and without frailty (Algorithms 1 and 2 respectively in the Appendix) [@xian2024; @xian2024a].

# 5. Results

## 5.1 Contextual Diagram

## 5.2 Technical Work

### 5.2.1 Key Requirements Met

-   O1: Created the `survregVB` package to implement the mean-field VB algorithm in R for parametric survival regression in log-logistic AFT models via the `survregVB()` function.

-   O2: Designed a user-friendly interface similar to `survreg` for ease of adoption.

-   O3: Created the `survregVB()` function that can be called with or without frailty to fit both standard and shared frailty log-logistic AFT models for clustered survival data.

-   O4: Included a test suite with unit tests to cover core functionalities.

-   O5: Documented all functions with clear explanations of inputs, outputs, and expected usage, with provided examples.

-   O6: Created a vignette with examples for models with and without shared frailty.

-   O7: Conducted simulation studies to validate the accuracy and efficiency of `survregVB`.

-   O8: Evaluated the package against publicly available survival data sets and compared results with traditional MCMC methods.

-   O9: Prepared `survregVB` for CRAN submission, ensuring compliance with R package standards.

### 5.2.2 System Design & Architecture

`survregVB` was based off existing R code from the `vbaft` repository (<https://github.com/chengqianxian/vbaft/tree/main>), which implements survival regression for right-censored log-logistic AFT models without shared frailty. However, significant modifications have been made to meet CRAN submission standards, and improve usability, performance and maintainability.

#### i) Architectural/Design Patterns Used

The \`survregVB\` follows the standard R package format [\@silge2019] and includes a test suite, a vignette, function documentation, and simulated and real-world data sets for use in examples and testing. Adherence to R package development best practices ensures usability and maintainability.

``` yaml
survregVB/
├── R/
│   ├── survregVB.R               # Primary user-facing function 
│   ├── survregVB.frailty.fit.R   # Implements VB with shared frailty 
│   ├── survregVB.fit.R           # Implements VB without shared frailty 
│   ├── summary.survregVB.R       # Summary method for survregVB
│   ├── print.survregVB.R         # Print method for survregVB
│   ├── print.summary.survregVB.R # Print method for summary.survregVB
│   ├── parameters.R              # Parameter update calculations for VB 
│   ├── ELBO.R                    # Convergence criteria calculations for VB
│   ├── data.R                    # Dataset documentation
│   ├── credible_intervals.R      # Computes Bayesian credible intervals 
│
├── tests/                        # Unit tests for functions found in R/ 
│   ├── testthat/
│
├── vignettes/                    
│   ├── survregVB.Rmd             # User guide and examples
│
├── man/                          # Documentation
│
├── data/                         # Example data sets 
│   ├── simulation_nofrailty.rda  # Simulated data set without clusters
│   ├── simulation_frailty.rda    # Simulated data set with clusters
│   ├── lung_cancer.rda           # Subset of the GSE102287 data set
│   ├── dnase.rda                 # Subset of the rhDNase data set
├── data-raw/                     # Clean raw data before saving in data/
│
├── DESCRIPTION                   # Package metadata
├── NAMESPACE                     # Function exports
├── LICENSE                       # License file
├── LICENSE.md                    # Readable version of license file 
└── README.md                     # Installation guide
```

#### ii) Component Interfaces

1.  `survregVB()` is the primary user-facing function for performing VB survival regression in an AFT model.

```{r}
survregVB <- function(
    formula,       # Model formula (e.g., Surv(time, status) ~ predictors)
    data,          # Data frame to interpret the variables. 
    alpha_0,       # Shape hyperparameter of b 
    omega_0,       # Scale hyperparameter of b
    mu_0,          # Mean hyperparameter of beta
    v_0,           # Precision hyperparameter of beta
    lambda_0,      # Shape hyperparameter for frailty component
    eta_0,         # Scale hyperparameter for frailty component 
    na.action = na.omit, # Handling of missing values
    cluster,       # Optional clustering variable for frailty models
    max_iteration = 100, # Maximum number of iterations for the VB algorithm
    threshold = 0.0001   # Convergence threshold for the ELBO
)
```

Its main role is to:

-   Parse the formula input (`Surv(time, status) ~ predictors`).

-   Check for missing data, outliers, and non-supported distributions.

-   Determine whether to use a frailty model (if `cluster` is specified).

-   Call either `survregVB.fit()` or `survregVB.frailty.fit()` based on model type.

-   Return a `survregVB` object with results and metadata.

2.  Core fitting functions

-   `survregVB.fit()` implements VB estimation for standard log-logistic AFT models without frailty.

-   `survregVB.frailty.fit()` implements VB estimation for standard log-logistic AFT models with shared frailty when the `cluster` variable is specified.

4.  S3 methods for interpreting/presenting results

-   `print.survregVB()` displays the posterior distributions of the AFT model parameters, and is called automatically when displaying results from `survregVB()`

-   `summary.survregVB()` provides a detailed model summary including standard deviations and credible intervals for the posterior distributions. It is called automatically by running `summary()`.

#### iii) Quality Attributes

-   Performance: `survregVB` employs VB instead of MCMC for faster convergence and similar estimation results.

-   Usability: Syntax mirrors `survreg()` from the `surival` package, making adoption easier for users already familiar with survival analysis in R [@survival]. Clear documentation and vignettes explain how to use `survregVB` effectively.

-   Reliability: Comprehensive unit tests validate correctness through an automated test suite.

-   Interoperability: Designed to work with standard R survival analysis workflows (supports **`Surv()`** notation from the `survival` package, and is compatible with standard R data frames and `tibble` formats) [@survival].

-   Security and Privacy: Since all computations occur in-memory within R, there are no external API calls or data transfers.

### 5.2.3 System Implementation & Testing

#### Algorithms & Techniques

The following tools and technologies were used in developing `survregVB`:

1.  Programming Language

-   R: The standard language for statistical computing and survival analysis. It provides built-in methods for data manipulation, model fitting, and visualization [@RProject].

2.  Libraries and Packages

Survival analysis:

-   `survival` - Core library for survival analysis routines, including definition of `Surv` objects and parametric AFT models [@survival].

-   `rstan` - R interface for `stan`, used for comparisons against MCMC techniques [@rstan].

Package and Development:

-   `devtools`, `usethis` - For general package development, including functions for automating R package creation and setup, testing and documenting functions, and building the package [@devtools; @usethis].

-   `testthat` - For writing function unit tests to ensure the package works as expected [@testthat].

-   `roxygen2` - To generate in-line function documentation in a standardized format [@roxygen2].

-   `knitr`, `rmarkdown` - To create vignettes that provide explanations and examples for the package functions [@knitr; @rmarkdown].

-   `styler`, `lintr` - To check R code for style and formatting issues to ensure clean and readable code throughout the package [@styler; @lintr].

-   `covr` - To check the test coverage of the package [@covr].

Other libraries:

-   `invgamma` - To sample from the inverse gamma distribution [@invgamma].

-   `stats` - For fundamental statistics for model estimation [@stats].

-   `GEOquery` - To access data from the NCBI Gene Expression Omnibus (GEO) for real-world data analysis [@GEOquery].

3.  Algorithms

-   `survregVB` implements Algorithms 1 and 2 in the Appendix through the `survregVB.fit()` and `survregVB.frailty.fit()` functions respectively.

4.  Development Environment & Version Control

-   RStudio - The primary development environment for writing, building and testing R packages [@silge2019].

-   GitHub - Version control and development.

#### Testing

`survregVB` uses the `testthat` package to automate testing and improve code structure, and ensure the functions are behaving as expected. Following the conventions of `testthat`, the test suite is found under the `/tests/testthat` directory and contains a corresponding test file for each file found under the `/R/` directory [@testthat]. The whole test suite is run by executing `devtools::test()` [@silge2019].

The `covr` package was used to measure code coverage for the entire `survregVB` package, ensuring that all components are covered by test cases [@covr]. The results indicate that 99.79% of the code base is covered by test cases, showing strong test coverage and robust code.

### 5.2.4 System Validation

`devtools::check()` was used during development for comprehensive package validation to ensure that `survregVB` meets CRAN standards. This command runs tests, checks documentation, verifies dependencies, and identifies potential issues such as missing imports, documentation inconsistencies, or coding errors [@devtools].

**`devtools::check()`** was used for comprehensive package validation, ensuring `survregVB` meets CRAN standards. This command performs the following checks [\@devtools]:

-   Runs automated tests to detect errors.

-   Validates documentation and function consistency.

-   Identifies missing dependencies and imports.

-   Ensures compliance with R package development best practices.

#### Case Study using `dnase`

We use the `dnase` data set included in the `survregVB` package as a case study of how to use `survregVB()` to fit an AFT model without frailty, and compare the results to those obtained by the VB algorithm found in `vbaft` to validate the system. `dnase` is a processed subset of the `rhDNase` data set found in `survival` and contains results of a trial of rhDNase for the treatment of cystic fibrosis [@survival].

1.  Model Specification

Our goal is to fit it a log-logistic AFT regression model of the form:

$$
\log(T):=Y=\beta_0+\beta_1x_1+\beta_2x_2+bz,
$$ where `trt` ($x_1$) and `fev` ($x_2$) are the covariates of interest, and the event status indicator is `infect` [@survival; @xian2024].

2.  Fitting the Model

First, we load the `survregVB` and `survival` libraries and view the data set documentation:

```{r loadLibrary}
library(survregVB)
library(survival)
?dnase
```

To fit the log-logistic AFT model using `survregVB`:

```{r}
fit <- survregVB(
  formula = Surv(time, infect) ~ trt + fev, data = dnase, alpha_0 = 501, omega_0 = 500,
  mu_0 = c(4.4, 0.25, 0.04), v_0 = 1, max_iteration = 10000, threshold = 0.0005,
  na.action = na.omit
)
print(fit)
summary(fit)
```

The distributions of $b$ and $\beta$ match those obtained from the VB algorithm in `vbaft`, validating the implementation.

#### Simulation Studies

We also simulate survival data with and without clustering to validate the performance of `survregVB` under different scenarios by comparing the results to those obtained by the VB algorithm found in `vbaft`.

1.  Scenario with frailty (`simulated_frailty`)

We will show an example using the `simulated_frailty` data set included in the package, which contains survival data generated as follows for the $j^{th}$ subject in the $i^{th}$ cluster, $i=1, \dots, K$ and $j=1,\dots, n_i$:

$$
\log(T_{ij})=0.5+\beta_1x_{ij1}+\beta_2x_{ij2}+\gamma_i+b\epsilon_{ij},
$$

-   $x_{ij1} \sim N(1, 0.2^2)$
-   $x_{ij2}\sim \text{Bernoulli}(0.5)$
-   $\epsilon_{ij}\sim \text{logistic}(0,1)$
-   $\gamma_i\sim N(0,\sigma_\gamma^2)$ with $\sigma^2_\gamma=1$
-   Censoring time $C_{ij}\sim \text{uniform}(0,d)$ where $t_{ij}=\min(T_{ij},C_{ij})$, and $\delta_{ij}=\mathbb{1}(T_{ij}\le C_{ij})$ and $d=48$ to achieve a 15% censoring rate [@xian2024a].

The following fits the model with non-informative priors:

```{r}
fit2 <- survregVB(
  formula = Surv(T.15, delta.15) ~ x1 + x2, data = simulation_frailty, alpha_0 = 3,
  omega_0 = 2, mu_0 = c(0, 0, 0), v_0 = 0.1, lambda_0 = 3, eta_0 = 2,
  cluster = cluster, max_iteration = 100, threshold = 0.01
)
print(fit2)
summary(fit2)
```

These distributions of $\beta$, $b$ (scale) and $\sigma_\gamma^2$ (intercept) match those obtained from the shared frailty VB algorithm from @xian2024a, validating the implementation.

2.  Scenario without frailty (`simulated_nofrailty`)

Similar simulation studies were performed using unclustered survival data found in the `simulated_nofrailty` data set included in `survregVB`. The results from these studies match those from the VB algorithm found in `vbaft`, validating the implementation.

## 5.3 Novelty of Results

While VB methods have been explored in statistical literature, no existing software provides a dedicated and user-friendly implementation of VB for AFT models. `survregVB` fills this gap by offering an efficient alternative to traditional MCMC-based Bayesian methods for survival analysis data that integrates seamlessly with existing R survival workflows, pre-processes data and handles missing values. These features make Bayesian inference more accessible to applied researchers in various fields, including medicine, engineering, and social sciences.

### Comparative Analysis to Other Work

To establish the novelty of `survregVB`, we compare its performance on two real-world data sets with:

-   Likelihood-based estimation using `survreg()` from `survival`.

-   HMC sampling from `rstan`.

For each of the following data sets, we fit a log-logistic AFT model, use historically motivated priors for Bayesian estimation, and compare parameter estimates, runtime, and model fit.

#### GSE102287 Data set

This data set, publicly available in the NCBI Gene Expression Omnibus (GEO), contains clinical and gene expression data from African American and European American patients with non-small cell lung cancer (NSCLC) [@mitchell2017]. A processed subset of 60 African American patients referred to as `lung_cancer` is included in `survregVB`, focusing on factors influencing survival, such as age, cancer stage, gender, and smoking status . Previous research shows that the log-logistic model is the best fit for the data as compared to other parametric models [@kumar2019].

We choose priors based off historical analysis on this type of data [@kumar2019]. We choose the log of half the follow-up period length, $\log(1825/2)\approx6.8$ as the mean of the intercept. To summarize, we consider the following prior distributions for the model parameters [@xian2024]:

-   $\beta\sim N_p(\boldsymbol{\mu}_0,\sigma_0^2\mathbf{I}_{p\times p}$), with $\boldsymbol{\mu}_0 = (6.8,0,0,0,0,0)$ and $v_0=1$

-   $b\sim \text{Inverse-Gamma}(\alpha_0,\omega_0)$ with $\alpha_0=11$ and $\omega_0=10$

The ELBO convergence threshold is set as $0.01$ which is the default recommendation [@yao2018yes]. To fit this model using `survregVB`, we use the following:

```{r}
fit <- survregVB(formula = Surv(time, status) ~ age + Stage + gender + factor(smoking),
                 data = lung_cancer, alpha_0 = 11, omega_0 = 10,
                 mu_0 = c(6.8, 0, 0, 0, 0, 0), v_0 = 1, threshold = 0.01)
```

#### Lung Data set 

The `lung` data set in the `survival` package contains survival data from 228 patients with advanced lung cancer from the North Central Cancer Treatment Group [@survival]. We have assessed that this data set is suitable for the log-logistic distribution.

We choose the log of the median follow-up period length, $\log(824)\approx6.7$ as the mean of the intercept and $0$ as the prior means for the other covariates based of previous studies [@ando2001; @kumar2019]. To summarize, we consider the following prior distributions for the model parameters [@xian2024]:

-   $\beta\sim N_p(\boldsymbol{\mu}_0,\sigma_0^2\mathbf{I}_{p\times p}$), with $\boldsymbol{\mu}_0 = (6.7,0,0,0,0,0)$ and $v_0=1$

-   $b\sim \text{Inverse-Gamma}(\alpha_0,\omega_0)$ with $\alpha_0=501$ and $\omega_0=500$

We fit the model as follows:

```{r}
fit2 <- survregVB(formula = Surv(time, status == 2) ~ age + factor(sex) +
                    factor(ph.ecog), data = lung, alpha_0 = 501, omega_0 = 500,
                  mu_0 = c(6.7, 0, 0, 0, 0, 0), v_0 = 1, threshold = 0.01)
```

#### Comparative Results 

The estimation results from `survregVB`, `survreg` and `rstan` for GSE102287 and `lung` are shown in Table 1 and Table 2 in the Appendix. The convergence of the MCMC algorithm was well assessed and checked by the trace plot and autocorrection plot [@comparis2021]. The results demonstrate that `survregVB` results align well with likelihood and MCMC-based estimates. Furthermore, the credible intervals from survregVB overlap with those from MCMC for both data sets, showing that it captures parameter uncertainty well.

For GSE102287, survregVB achieves a 960x speedup (41.5504 sec → 0.0431 sec), and for `lung`, survregVB achieves a 160x speedup (12.5573 sec → 0.0765 sec). This significant reduction in runtime confirms that VB provides a stable and computationally efficient alternative to MCMC-based inference. Furthermore, unlike `rstan`, `survregVB` automates preprocessing (handling missing data, categorical variables, etc.), making Bayesian inference accessible to applied researchers.

# 6. Discussion

## 6.1 Threats to the Validity of the Results

## 6.2 Implications of the Research Results

Since no existing software provides VB methods for AFT models, the development of `survregVB` will fill this gap to offer an efficient alternative to MCMC-based methods. Applying VB inference to a variety of data sets, such as ones with small sample sizes, many covariates or differing cluster sizes, provides new insight into its robustness and practicality. Comparing results with traditional techniques provides further information on the computational cost and accuracy of the VB methods. This evaluation will help address the strengths and weaknesses of the current VB algorithms, and identify areas for future research for Bayesian inference in survival models.

As survival analysis is an important field of study across multiple domains, `survregVB` will benefit researchers involved in biology, medicine, engineering, marketing, social sciences or behavioral sciences [@emmert-streib2019]. The package will be freely available through CRAN, making VB inference widely accessible to end users. Function documentation will be available in the package, and a vignette will serve as an in-depth guide to improve usage. Furthermore, the package will automatically handle missing values, perform one-hot encoding, and generate summary statistics, streamlining the analysis process.

## 6.3 Limitations of the Results

## 6.4 Generalisability of the Results 

# 10. Appendix

**Algorithm 1**: Variational Bayes Inference of Survival Data using a Log-logistic AFT Model [@xian2024]

**Data**: a sample of independent log observed time $y_i$, their corresponding covariate vectors $\mathbf{X}_i$ and the right censoring indicator $\delta_i,i=1,\ldots,n$ where $n$ is the sample size; values of hyperparameters: $\boldsymbol{\mu}_0,v_0,\alpha_0$ and $\omega_0$; convergence threshold $\gamma$ and maximum number of iterations $M$

**Result**: posterior distributions of $\beta$ and $b$, and their hyperparameters $\Sigma,\boldsymbol{\mu},\alpha,\omega$

1 **Initialization**: initialize $\omega=\omega_0$ and $\boldsymbol{\mu}=\boldsymbol{\mu}_0$, set $m=0$ and $\text{ELBO}=0$;

2 **Calculation**: obtain $\alpha$ by $\alpha=\alpha_0+r$ with $r=\sum_{i=1}^{n}\delta_i$;

3 **while** iteration $m<M$ and difference of $\text{ELBO}>\gamma$ **do**

4 $m=m+1$;

5 $\Sigma^{(m)} \leftarrow
\left[ v_0 \mathbf{I}
+ 2 \mathbb{E}_{q(b)} \left(\frac{1}{b^2} \right)
\sum_{i=1}^{n} (1+\delta_i) \xi_i \mathbf{X}_i \mathbf{X}_i^T
\right]^{-1}$;

6 $\boldsymbol{\mu}^{(m)} \leftarrow\left[ \left\{ v_0 \boldsymbol{\mu}_0^T
+ \sum_{i=1}^{n} \left(\mathbb{E}_{q(b)} \left(\frac{1}{b} \right)
\left( -\delta_i + (1+\delta_i) \rho_i \right) \mathbf{X}_i^T
+ 2 \mathbb{E}_{q(b)} \left(\frac{1}{b^2} \right) (1+\delta_i) y_i \xi_i \mathbf{X}_i^T \right) \right\} \Sigma^{(m)} \right]^T$;

7 $\omega^{(m)}\leftarrow\omega_0-\sum_{i=1}^n(\delta_i-(1+\delta_i)\phi_i)(y_i-\mathbf{X}_i^T\boldsymbol{\mu}^{(m)})$;

8 calculate the current $\text{ELBO},\text{ELBO}^{(m)}$;

9 calculate the current difference of $\text{ELBO}$, $\text{ELBO}^{(m)}-\text{ELBO}^{(m-1)}$;

10 **end**

**Algorithm 2**: Variational Bayes Inference of Survival Data using a Shared Frailty Log-logistic AFT Model [@xian2024a]

**Data**: a sample of independent log observed time $y_i$, their corresponding covariate vectors $\mathbf{X}_i$ and the right censoring indicator $\delta_{ij},i=1,\ldots,K,\ j=1,\ldots,n_i$ for the $j^{th}$ observation from the $i^{th}$ group; values of hyperparameters: $\boldsymbol{\mu}_0,v_0,\alpha_0,\omega_0,\lambda_0$ and $\eta_0$; convergence threshold $\Delta$ and maximum number of iterations $M$

**Results**: posterior distributions of $\beta,\gamma_i,i=1,\ldots,K,b$ and $\sigma_\gamma^2$, and their parameters $\Sigma,\boldsymbol{\mu},\sigma_i^2,\tau_i,\alpha,\omega,\lambda,\eta$

1 **Initialization**: initialize $\omega=\omega_0, \boldsymbol{\mu}=\boldsymbol{\mu}_0, \tau_i=0$ and $\lambda=\lambda_0$, set $m=0$ and $\text{ELBO}=0$;

2 **Calculation**: obtain $\alpha$ by $\alpha=\alpha_0+\delta$ with $\delta=\sum_{i=1}^{K}\sum_{j=1}^{n_i}\delta_ij$ and $\lambda$ by $\lambda=\lambda_0+K/2$;

3 **while** iteration $m<M$ and difference of $\text{ELBO}>\Delta$ **do**

4 $m=m+1$;

5 $\Sigma^{(m)} \leftarrow
\left[ v_0 \mathbf{I}_{p\times p}
+ 2 \mathbb{E}_{q(b)} \left(\frac{1}{b^2} \right)
\sum_{i=1}^{K}\sum_{j=1}^{n_i} (1+\delta_{ij}) \xi_{ij} \mathbf{X}_{ij} \mathbf{X}_{ij}^T
\right]^{-1}$;

6 $\boldsymbol{\mu}^{(m)} \leftarrow
\left[
\left\{ v_0 \boldsymbol{\mu}_0^T
+ \sum_{i=1}^{K} \sum_{j=1}^{n_i}
\Bigg(
\mathbb{E}_{q(b)} \left(\frac{1}{b} \right)
\left( -\delta_{ij} + (1+\delta_{ij}) \rho_{ij} \right)
+ 2 \mathbb{E}_{q(b)} \left(\frac{1}{b^2} \right)
(1+\delta_{ij}) \xi_i
\Big( y_{ij} - \mathbb{E}_{q(\gamma_i)} (\gamma_i) \Big)
\mathbf{X}_{ij}^T
\Bigg)
\right\} \Sigma^{(m)}
\right]^T$;

7 $\sigma_i^{2(m)} \leftarrow
\left[
\mathbb{E}_{q(\sigma_\gamma^2)}\left(\frac{1}{\sigma_\gamma^2}\right)
+ 2\mathbb{E}_{q(b)}\left(\frac{1}{b^2}\right)(1+\delta_{ij})\xi_{ij}
\Big(y_{ij}-\mathbf{X}_{ij}^T\mathbb{E}_{q(\boldsymbol{\beta})}(\boldsymbol{\beta})\Big)
\right], \quad i=1,\dots,K$;

8 $\tau_i^{(m)} \leftarrow \sigma_i^{2(m)}
\sum_{j=1}^{n_i}
\left[
\mathbb{E}_{q(b)} \left(\frac{1}{b} \right)
\Big(-\delta_{ij}+(1+\delta_{ij})\rho_{ij}\Big)
+ 2\mathbb{E}_{q(b)} \left(\frac{1}{b^2}\right)(1+\delta_{ij})\xi_{ij}
\Big(y_{ij}-\mathbf{X}_{ij}^T\mathbb{E}_{q(\boldsymbol{\beta})}(\boldsymbol{\beta})\Big)
\right], \quad i=1,\dots,K$;

9 $\omega^{(m)} \leftarrow \omega_0 - \sum_{i=1}^K \sum_{j=1}^{n_i}
\left( \delta_{ij} - (1 + \delta_{ij} \delta_{ij}) \right)
\left( y_{ij} - \mathbf{X}_{ij}^T \mathbb{E}_{q(\boldsymbol{\beta})}(\boldsymbol{\beta})
- \mathbb{E}_{q(\gamma_i)}(\gamma_i) \right)$;

10 $\eta^{(m)} \leftarrow \eta_0 + \frac{1}{2} \sum{i=1}^K \mathbb{E}_{q(\gamma_i)}\gamma_i^2$;

11 calculate the current $\text{ELBO},\text{ELBO}^{(m)}$;

12 calculate the current difference of $\text{ELBO}$, $\text{ELBO}^{(m)}-\text{ELBO}^{(m-1)}$;

13 **end**

**Table 1**: Results from analysis on NCBI lung cancer data: Posterior means (Mean) with posterior standard deviations (SD), and 95% credible intervals (95% Cred. Int.) from the VB algorithm implemented by `survregVB` and MCMC, respectively. Point estimates (Est.) with standard errors (SE), and 95% confidence interval (95% Conf. Int.) from `survreg` in the R package `survival`

**Table 2**: Results from analysis on lung cancer data from the R package `survival`: Posterior means (Mean) with posterior standard deviations (SD), and 95% credible intervals (95% Cred. Int.) from the VB algorithm implemented by `survregVB` and MCMC, respectively. Point estimates (Est.) with standard errors (SE), and 95% confidence interval (95% Conf. Int.) from `survreg` in the R package `survival`

# References
