---
title: "survregVB"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{survregVB}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

# Introduction

This vignette demonstrates how to use the `survregVB` function from the
`survregVB` package to fit a log-logistic Accelerated Failure Time (AFT)
model. This function uses Variational Bayes (VB) to infer the model
parameters by maximizing the Evidence Lower Bound (ELBO). We will use
the `rhDNase` dataset from the `survival` package to illustrate the
process. Specifically, we will show you how to prepare the data, set
prior distributions, fit the model, and interpret the results.

# Installation

First, install the `survregVB` package if not already installed. Since
we'll be using the `rhDNase` dataset, install the `survival` package as
well:

```{r install, eval=FALSE}
install.packages("survregVB")
install.packages("survival")
```

# Basic Usage

Once installed, you can load both libraries with the `library()`
function:

```{r setup}
library(survregVB)
library(survival)
```

# Preparing the Data

The `rhDNase` dataset contains the results of a randomized trial of
rhDNase for the treatment of cystic fibrosis. The survival time, *T*, is
defined as the time until the first pulmonary exacerbation. *T* is
calculated as the difference between the date of entry into the study
(`entry.dt`) and date of last follow-up (`end.dt`), with the follow-up
period capped at 169 days. The covariates of interest are:

-   Treatment (`trt`: 0=placebo, 1=rhDNase), and
-   Forced expiratory volume (`fev`)

Here is a preview of the `rhDNase` dataset:

```{r}
head(rhDNase)
```

Next, we need to prepare the data for modeling:

```{r}
# Extract the first row for each subject
first <- subset(rhDNase, !duplicated(id)) 
dnase <- tmerge(first, first, id=id, tstop=as.numeric(end.dt -entry.dt))

# Subject whose fu ended during the 6 day window after finishing their 
# antibiotics are not counted as new infections
temp.end <- with(rhDNase, pmin(ivstop+6, end.dt-entry.dt))

# Create the event indicator
dnase <- tmerge(dnase, rhDNase, id=id,
                infect=event(ivstart),
                end=  event(temp.end))

# Toss out the non-at-risk intervals, and extra variables
dnase <- subset(dnase, (infect==1 | end==0), c(id:trt, fev:infect))

# Remove duplicated subjects
dnase <- subset(dnase, !duplicated(id))

# Set the survival time 
dnase$time <- dnase$tstop - dnase$tstart

head(dnase)
```

Now, the dataset is ready with the survival time (`time`) and event
indicator (`infect`).

# Defining the AFT Model

Our goal is to fit it a log-logistic AFT regression model of the form:

$${\log(T):=Y=\beta_0+\beta_1x_1+\beta_2x_2+bz}$$ where:

-   $x_1$ is `trt`,

-   $x_2$ is `fev`, and

-   $z$ is a random variable following a standard logistic distribution
    with scale parameter *b*.

The event of interest is whether or not the subject experienced
infection, `infect`.

## Formula Specification

We define a formula, where the left-hand side is a survival object
returned by the `Surv` function, and the right-hand side consists of the
covariates, `trt` and `infect`. The object returned by the `Surv`
function consists of the time and event of interest. In this case, the
time is `time` and the event of interest is `infect`:

```{r}
formula <- Surv(time, infect) ~ trt + fev
```

# Setting Prior Distributions

Next we define the prior distributions of the model parameters, *β* and
*b*.

The prior distribution of the scale parameter *b* is:

$$
b\sim\text{Inverse-Gamma}(\alpha_0,\omega_0)
$$

where:

-   $alpha_0$ is the shape, and

-   $\omega_0$ is the scale.

We set hyperparameters $\alpha_0=501$ and $\omega_0=500$ to achieve a
mean scale of one:

```{r}
alpha_0 <- 501
omega_0 <- 500
```

For the vector of coefficients for the covariants, *β*, the prior
distribution is a multivariate normal distribution:

$$\beta\sim\text{MVN}(\mu_0,\sigma_0^2I_{p*p})$$where:

-   $\mu_0$ is the vector of means,

-   $\sigma_0^2$ is the variance, and

-   $v_{0}=1/\sigma^2$ is the precision.

The prior means for $\mu_0$ are chosen based on historical data and
similar analyses on this type of data:

-   for the intercept $\beta_0$, we use $\log(169/2)\approx4.4$ (half
    the follow-up period),

-   for $\beta_1$ (`trt`), we use $\log(1.28)\approx0.25$, and

-   for $\beta_2$ (`fev`) we use $\log(1.04)\approx0.04$.

For the precision hyperparameter, we use a low precision $v_0=1$ to
obtain a flat prior:

```{r}
mu_0 <- c(4.4, 0.25, 0.04)
v_0 <- 1
```

# Fitting the model

Now that we have set up the formula and prior distributions, we can fit
the `rhDNase` dataset to the log-logistic AFT model using the
`survregVB` function. The remaining parameters we need to set are:

-   `max_iteration`: The maximum number of iterations the VB algorithm
    will run for. In this case, we allow up to 10,000 iterations to
    ensure that the algorithm has enough time to converge.

-   `threshold`: The convergence threshold based on the change in the
    ELBO between iterations. In this case, the algorithm will stop if
    the change in ELBO becomes smaller than 0.0005.

```{r}
fit <- survregVB(formula = Surv(time, infect) ~ trt + fev, 
                 data = dnase, 
                 alpha_0 = 501,
                 omega_0 = 500,
                 mu_0 = c(4.4, 0.25, 0.04), 
                 v_0 = 1, 
                 max_iteration = 10000, 
                 threshold = 0.0005)
fit
```

If the VB algorithm reaches the maximum number of iterations before
converging, we will receive a warning message:

```{r}
survregVB(formula = Surv(time, infect) ~ trt + fev, 
          data = dnase, 
          alpha_0 = 501,
          omega_0 = 500,
          mu_0 = c(4.4, 0.25, 0.04), 
          v_0 = 1, 
          max_iteration = 9, 
          threshold = 0.0005)
```

At the end of the model fitting process, the VB algorithm obtains the
approximated posterior distributions of *b* and *β*.

The approximated posterior distribution of the scale parameter *b* is:

$$
b\sim\text{Inverse-Gamma}(\alpha,\omega)
$$

where:

-   $\alpha$ is the shape, and

-   $\omega$ is the scale.

The approximated posterior distribution of the vector of coefficients
*β* is:

$$
\beta\sim N_p(\mu,\Sigma)
$$

where:

-   $\mu$ is the vector of means, and

-   $\Sigma$ is the covariance matrix of the coefficients.

The `survregVB` function returns a list containing results including:

-   `ELBO`: The value of the converged ELBO. If the algorithm does not
    converge before reaching `max_iteration`, will be the value of ELBO
    at the final iteration.

-   `alpha`: The final value of parameter $\alpha$ of the approximate
    posterior distribution of *b.*

-   `omega`: The final value of parameter $\omega$ of the approximate
    posterior distribution of *b.*

-   `mu`: The final value of parameter $\mu$ of the approximate
    posterior distribution of *β*.

-   `Sigma`: The final value of parameter $\Sigma$ of the approximate
    posterior distribution of *β*.

-   `iterations`: The number of iterations the algorithm performs before
    converging or reaching `max_iteration`.

We can access each item in the list using the `$` operator. For example,
if we want to view the evidence lower bound (ELBO):

```{r}
fit$ELBO
```
